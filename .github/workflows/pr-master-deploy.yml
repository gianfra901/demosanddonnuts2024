name: Delete Files in Master

on:
    workflow_dispatch:

jobs:
  delete-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          repository: 'gianfra901/app1-application'
          token: ${{ secrets.GH_TOKEN_USER }}
          path: app1-application

      - name: Delete all files except .git
        run: |
          cd app1-application
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          ls -a
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_USER }}

    #   - name: Commit changes
    #     run: |
    #       cd app1-application
    #       ls -a
    #       git config --global user.name 'github-actions[bot]'
    #       git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    #       git add .
    #       git commit -m "Delete all files in main"
    #       git push origin main
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GH_TOKEN_USER }}


      - name: Create Pull Request
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GH_TOKEN_USER }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/gianfra901/app1-application/pulls \
            -d '{
              "title": "Automated Pull Request",
              "head": "feature/KAN-45",
              "base": "main",
              "body": "This pull request contains automated changes."
            }'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_USER }}    


      - name: Force Merge Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_USER }}
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GH_TOKEN_USER }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"base":"'main'","head":"'feature/KAN-45'","commit_message":"Force merge from feature/KAN-45 to MAIN"}' \
            https://api.github.com/repos/gianfra901/app1-application/merges          

    #   - name: Merge Branch
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GH_TOKEN_USER }}
    #     run: |
    #       cd app1-application
    #       ls -a
    #       git config --global user.name "github-actions[bot]"
    #       git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
    #       git merge origin/feature/KAN-45  # Replace with your source branch name
    #       git push origin main # Replace with your target branch name      

    #   - name: Install GitHub CLI
    #     run: |
    #       sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C99B11DEB97541F0
    #       sudo apt-add-repository https://cli.github.com/packages
    #       sudo apt update
    #       sudo apt install gh         


    #   - name: Create Pull Request
    #     run: |
    #       gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"
    #       gh pr create --repo gianfra901/app1-application --title "Automated Changes" --body "This pull request contains automated changes." --head feature/KAN-45 --base main
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    #   - name: Merge Pull Request
    #     run: |
    #       PR_NUMBER=$(gh pr list --repo gianfra901/app1-application --head feature/KAN-45 --json number --jq '.[0].number')
    #       gh pr merge $PR_NUMBER --merge
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}